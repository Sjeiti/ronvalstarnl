{"id":"938","description":"How to use the Wordpress media library in a plugin or custom post type... the right way.","date":"2012-05-01T21:42:37","modified":"2016-12-14T20:04:32","slug":"using-wordpress-media-library-in-a-plugin","type":"post","excerpt":"<p>I just spent a couple of hours trying to figure this one out. Here&#8217;s how to use the WordPress media library in a plugin or custom post type&#8230; the right way.</p>","categories":["code","Javascript","backend","Wordpress"],"tags":["hack","plugin","Wordpress"],"metaKeyword":"media library","metaTitle":"Using Wordpress media library in a plugin","metaDescription":"How to use the Wordpress media library in a plugin or custom post type... the right way.","inCv":false,"inPortfolio":false,"dateFrom":"","dateTo":"","title":"Using WordPress media library in a plugin","content":"<p>I just spent a couple of hours trying to figure this one out. Here&#8217;s how to use the WordPress media library in a plugin or custom post type&#8230; the right way.</p>\n<p><!--more--></p>\n<p>It took me a while to to get this right. So much for Google because everybody with a similar problem posted the same solution, mostly with the same cumbersome code (why bother writing a new post if you&#8217;re just gonna copy-paste the code from someone elses blog).</p>\n<p><del data-reason=\"let's not be all negative about this; we all love WordPress :-)\">But before I proceed: carefull not to turn this post into a rant I&#8217;ll say it now just to get it over with: &#8220;Wow, what a bunch of poorly documented, badly written spaghetti code WordPress is&#8221;. That&#8217;s it.</del></p>\n<p>If you look a bit closer to the admin source you&#8217;ll find a Javascript click-implementation for all &#8216;a.thickbox&#8217; (media-upload.dev.js ln 65-71).<br />\nA bit further you&#8217;ll see that the upload uri for that &#8216;a.thickbox&#8217; can be retreived with the PHP function &#8216;get_upload_iframe_src($type)&#8217;. Now it doesn&#8217;t say anywhere what that $type is supposed to be but digging through the code (media.php) and doing some trial and error it seems a string of the possible values: image, video, audio, file or media (where the latter is any of the previous but file). If you want extra types checkout <a href=\"http://codex.wordpress.org/Function_Reference/add_filter\">add_filter</a> with &#8216;<a href=\"http://codex.wordpress.org/Plugin_API/Filter_Reference/upload_mimes\">upload_mimes</a>&#8216;.</p>\n<p>All we need now is to add a javascript callback function.<br />\nThe javascript callback function is a global. This is bloody ridiculous but not surprising if you&#8217;ve ever inspected window or $_GLOBAL in WordPress.<br />\nThe callback function returns a different HTML string depending on the type of file you&#8217;ve selected (type image has an image tag inserted).<br />\nWhat all these identical solutions on Google do wrong is that they set this global javascript callback function (and add placeholders) the moment you enter the page. It is neater to set it the moment you press the &#8216;a.thickbox&#8217; button, this way you can adjust your callback when you have multiple uploads (ie an image and a pdf).</p>\n<p>Once you&#8217;ve added the thickbox and setup the javascript callback you should be able to use the WordPress media library.</p>\n<p>But what if you do not want that HTML that is returned but, say, a post_id (more experienced WordPress users will know that posts, pages, attachements, images and everything are all stored in the table [wp]_posts). With the post_id (or attachement_id) you&#8217;d be able to use more than just an image- or attachement uri, you can also use the title and/or description of a file.</p>\n<p>As said, the callback function returns a different types of HTML. The image HTML snippet contains the attachement_id but the others don&#8217;t. When you trace back where the callback function is invoked you&#8217;ll find an <a href=\"http://codex.wordpress.org/Function_Reference/add_filter\">add_filter hook</a> called &#8216;media_send_to_editor&#8217;. It&#8217;s nowhere to be found on <a href=\"http://codex.wordpress.org/\">codex.wordpress.org</a> but it&#8217;s easy enough to implement. The call itself is done in media.php ln 488 (apply_filters(&#8216;media_send_to_editor&#8217;, $html, $send_id, $attachment)). And if you look through the surrounding function you&#8217;ll see the $send_id is exactly what we need. Not only that; the $attachement parameter is an associative array filled with other usefull stuff (title,description etc&#8230;).<br />\nWe overwrite the $html parameter (the filter callback expects $html returned) and set the priority of the filter to something really high so we know for sure it&#8217;s the last function applied&#8230; and we&#8217;re there&#8230;<br />\n&#8230;or are we?<br />\nHooking up to &#8216;media_send_to_editor&#8217; will also cause whatever you do in that function to happen in the normal text editor (after all: that&#8217;s what we&#8217;re hacking into).<br />\nSo we need to try to determine were we come from. There is the $_POST[&#8216;_wp_http_referer&#8217;] but if you examine it you&#8217;ll see that it does not contain the $GET vars we added to the upload button href. It took me a while to notice: if you check the upload iframe uri you&#8217;ll see that somebody did a very sloppy job off chopping of the last $GET variables after &#8216;TB_iframe&#8217; (WTF WordPress, seriously?!). So don&#8217;t append or use add_query_arg but insert your extra variables.</p>\n<p>So since we now know  where we come from we can use this in our hook function. We don&#8217;t even have to parse an HTML string. We just want some data so we&#8217;re going to parse JSON.</p>\n<p>Here is an example custom post type: <a href=\"/wordpress/wp-content/uploads/foobarbaz.zip\" download=\"foobarbaz.zip\">foobarbaz.zip</a> (simply add it to your theme dir and include the php file in your functions.php).</p>\n<p>There are two important lines in the PHP (the rest is mainly for building a custom post type):</p>\n<pre><code data-language=\"php\" data-line=\"67\">$sUri = esc_url( str_replace('&amp;type=','&amp;target=foobarbaz&amp;input='.$sInputName.'&amp;preview='.$sPreview.'&amp;tab=library&amp;type=',get_upload_iframe_src($sSubType)) );</code></pre>\n<p>This is the code for creating the uri used in the upload button. Notice the insertion of the $GET vars.<br />\nAnd there is the entire mediaSendToEditor function on line 81.<br />\n<label class=\"code\">file: posttype-foobarbaz.php</label></p>\n<pre><code data-language=\"php\" data-line=\"81\">function mediaSendToEditor($html, $attachment_id, $attachment) {\n\t// check for the GET vars added in boxView\n\tparse_str($_POST['_wp_http_referer'], $aPostVars);\n\tif (isset($aPostVars['target'])&&$aPostVars['target']=='foobarbaz') {\n\t\t// add extra data to the $attachement array prior to returning the json_encoded string\n\t\t$attachment['id'] = $attachment_id;\n\t\t$attachment['edit'] = get_edit_post_link($attachment_id);\n\t\t$attachment['input'] = $aPostVars['input'];\n\t\t$attachment['preview'] = $aPostVars['preview'];\n\t\tif ($aPostVars['type']=='image') {\n\t\t\tforeach (array('thumb','medium','large') as $size) {\n\t\t\t\t$aImg = wp_get_attachment_image_src( $attachment_id, $size);\n\t\t\t\tif ($aImg) $attachment['img_'.$size] = $aImg[0];\n\t\t\t}\n\t\t}\n\t\t$html = json_encode($attachment);\n\t}\n\treturn $html;\n}</code></pre>\n<p>There&#8217;s also a tiny caveat conserning the &#8216;Insert into post&#8217; button in the upload iframe. If you create a custom post type that does not support &#8216;editor&#8217; you&#8217;ll have to add this button yourself.</p>\n<p>Here&#8217;s the js responsible for the callback:<br />\n<label class=\"code\">file: scripts/foobarbaz.js</label></p>\n<pre><code data-language=\"javascript\">(function($){\n\tvar fnOldSendToEditor;\n\t$(function(){\n\t\t// store original send_to_editor function\n\t\tfnOldSendToEditor = window.send_to_editor;\n\t\t// add a different send_to_editor function to each thickbox anchor\n\t\tvar $Box = $('#foobarbaz-box');\n\t\tif ($Box.length) {\n\t\t\t$Box.find('a.thickbox').each(function(i,el){\n\t\t\t\tvar $A = $(el).click(function(){\n\t\t\t\t\twindow.send_to_editor = getFnSendToEditor($A.data('type'));\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t\t// hack tb_remove to reset window.send_to_editor\n\t\tvar fnTmp = window.tb_remove;\n\t\twindow.tb_remove = function(){\n\t\t\tif (fnOldSendToEditor) window.send_to_editor = fnOldSendToEditor;\n\t\t\tfnTmp();\n\t\t};\n\t});\n\tfunction getFnSendToEditor(type){\n\t\treturn function(fileHTML){\n\t\t\tvar oData = JSON.parse(fileHTML);\n\t\t\t//console.log(oData);\n\t\t\t$('#'+oData.input).val(oData.url);\n\t\t\t$('#'+oData.preview).text(type+': '+oData.url.split('/').pop());\n\t\t\ttb_remove();\n\t\t}\n\t}\n})(jQuery);</code></pre>\n<p>First the original send_to_editor function is stored. Then each a.thickbox is assigned an onclick to replace the send_to_editor. This function creates and returns an anonymous function in order to parse the &#8216;type&#8217; parameter through it&#8217;s scope (not manditory but a nice alternative to the insertion of the $GET vars).<br />\nThen we hack into tb_remove to restore the original send_to_editor function (since we also want this to happen when you simply close the upload iframe).<br />\nYou&#8217;ll also notice that the original global &#8216;send-to-editor&#8217; function is stored and restored on callback so as to maintain it&#8217;s original texteditor functionality. And that&#8217;s it.</p>\n<p>So there you have it&#8230;</p>\n<p>(once again: <a href=\"/wordpress/wp-content/uploads/foobarbaz.zip\" download=\"foobarbaz.zip\">foobarbaz.zip</a>)</p>"}