<!--
  date: 9999-99-99
  modified: 9999-99-99
  slug: prerendering
  type: post
  header: vino-li-55nuS2rUYmQ-unsplash.jpg
  headerColofon: photo by [Vino Li](https://unsplash.com/@vinomamba24)
  categories: code, work
  tags: seo, rss
  description: 
-->

# Prerendering

Ever since Google could render JavaScript (about ten years ago) I stopped worrying about prerendering my content.
I really can't be bothered with SEO, but one thing that did always bug me was that RSS previews did not show any content, but the initial index prior.

I did make some half hearted attempt to use [Netlify](https://docs.netlify.com/site-deploys/post-processing/prerendering/) and/or [Prerender.io](https://prerender.io/), but never really got it working properly.


## Doing it myself

Since I sometimes enjoy hour long train rides, and I can develop this site on [Termux](https://termux.dev/en/) using [Vim](https://www.vim.org/), I thought I'd have another go at it.
I was thinking of using [JSDOM](https://github.com/jsdom/jsdom). My experience with JSDOM involved unit-testing. And although I firmly believe DOM related testing should be done in a browser, prerendering might just work perfectly with JSDOM.

### Getting started

To get [a JSDOM instance](https://github.com/jsdom/jsdom?tab=readme-ov-file#basic-usage) requires an HTML string and a location (the latter is optional, but useful in our case).
The HTML is what initially was used as [starting point](https://github.com/Sjeiti/ronvalstarnl/blob/master/src/index.html).

Next to figure out is what code to run to render any page. Just running the regular main-js might seem smart but it loads a lot of things we do not really need for a first render. We also wouldn't want to remove the `no-js` class in the prerender.

So we do a dynamic import for all the views, and the `open` method from the router.

### DOM issues

At which point errors started being thrown around. Most of these stemmed from `window` properties not being accessible on `globalThis`. For instance when you do `document.querySelector` you simply assume `document` to be a global.
Simply merging `window` into `globalThis` might seem like a good plan but it fails so often that it is easier to set specific properties one by one.

Then there is the missing `fetch`. But since we're still running Node, we'll write an adapter from `fs.readFile` to `fetch`.

There are some methods that require a noop, and we're good to go.

### Node doesn't do raw imports

For Webpack I was still using the [`raw-loader`](https://v4.webpack.js.org/loaders/raw-loader/) to import and place SVG symbol definitions. This does not work in Node as it does not understand the `!!raw-loader!` syntax.

But more importantly; the amount of SVG data multiplied by the amount of pages is substantial in terms of extra MB's (27.7 to be exact). The SVG data is really not needed in the prerendered HTML.

So we'll do that conditionally by checking the `globalThis.prerendering` boolean we set at the start of our prerendering code.

### Isolation

All this worked for a single route but not for an array. I had hoped it would work by simply setting the JSDOM URL and calling the router again, or reinitialising JSDOM, but alas.

Luckily the answer is the solution to another problem. Prerendering over 300 pages takes some time. A logical pattern would be to use workers, since these can run in parallel. An added benefit is the isolated scope in which to call the dynamic imports.

Now all I had to do is figure out the amount of workers to call and create a dynamic equivalent for `Promise.all`.

## Result

The result is an extra 287 files with a total size of 5.2 MB. The total number of files is a bit 'polluted' by the thousands of files generated by [the static search](/refactoring-for-speed#searching-is-hard). I've corrected for them below, denoted by 'files*'.

|        | before | after   |
|--------|--------|---------|
| size   | 8.6 MB | 13.8 MB |
| files  | 5253   | 5540    |
| files* | 399    | 686     |

<!--

5253 total files, 8.6 MB total size of deploy

5540 total files, 41.5 MB total size of deploy

4854 399

     686

328


5540 total files, 13.8 MB total size of deploy

-->
